<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Eureka源码学习笔记(一) | Imfan笔记</title>
  <meta name="keywords" content=" 注册中心 , eureka ">
  <meta name="description" content="Eureka源码学习笔记(一) | Imfan笔记">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
<meta name="description" content="事件推送实现方式 WebSocket SseEmitter  对比   实现方式 建立连接 传输效率 兼容性 传输内容 功能 使用场景    WebSocket 采用双工通信,客户端和服务器建立实时的双向通信信道。 建立后保持连接不断,效率高于SSE。 现代浏览器基本全面支持。 支持传输文本以及二进制数据。 支持双向全 duplex 通信,客户端和服务器都可以主动发送消息。 适用于需要实时双向交互">
<meta property="og:type" content="article">
<meta property="og:title" content="SpringBoot-EventStream">
<meta property="og:url" content="https://wiki.aistart.cc/2023/12/06/backend/spring/springboot-event-stream/index.html">
<meta property="og:site_name" content="Imfan笔记">
<meta property="og:description" content="事件推送实现方式 WebSocket SseEmitter  对比   实现方式 建立连接 传输效率 兼容性 传输内容 功能 使用场景    WebSocket 采用双工通信,客户端和服务器建立实时的双向通信信道。 建立后保持连接不断,效率高于SSE。 现代浏览器基本全面支持。 支持传输文本以及二进制数据。 支持双向全 duplex 通信,客户端和服务器都可以主动发送消息。 适用于需要实时双向交互">
<meta property="og:locale" content="zh_CN">
<meta property="article:published_time" content="2023-12-06T07:10:00.000Z">
<meta property="article:modified_time" content="2023-12-06T07:23:20.211Z">
<meta property="article:author" content="imfan">
<meta property="article:tag" content="事件推送">
<meta name="twitter:card" content="summary">


<link rel="icon" href="/img/road.png">

<link href="/css/style.css?v=1.1.0" rel="stylesheet">

<link href="/css/hl_theme/atom-dark.css?v=1.1.0" rel="stylesheet">

<link href="https://cdn.bootcss.com/animate.css/4.1.0/animate.min.css" rel="stylesheet">

<link href="https://cdn.bootcss.com/photoswipe/4.1.3/photoswipe.min.css" rel="stylesheet">
<link href="https://cdn.bootcdn.net/ajax/libs/photoswipe/4.1.3/default-skin/default-skin.min.css" rel="stylesheet">

<script src="https://cdn.bootcdn.net/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
<script src="/js/titleTip.js?v=1.1.0" ></script>

<script src="https://cdn.bootcdn.net/ajax/libs/highlight.js/9.16.2/highlight.min.js"></script>
<script>
    hljs.initHighlightingOnLoad();
</script>

<script src="https://cdn.bootcdn.net/ajax/libs/nprogress/0.2.0/nprogress.min.js"></script>


<script src="https://cdn.bootcdn.net/ajax/libs/jquery-cookie/1.4.1/jquery.cookie.min.js" ></script>

<script src="/js/iconfont.js?v=1.1.0" ></script>

<script src="https://cdn.bootcdn.net/ajax/libs/mermaid/9.1.1/mermaid.js"></script>

<meta name="generator" content="Hexo 5.4.2"></head>
<div style="display: none">
  <input class="theme_disqus_on" value="false">
  <input class="theme_preload_comment" value="">
  <input class="theme_blog_path" value="">
  <input id="theme_shortcut" value="true" />
  <input id="theme_highlight_on" value="true" />
  <input id="theme_code_copy" value="true" />
</div>



<body>
<aside class="nav">
    <div class="nav-left">
        <a href="/" class="avatar_target">
    <img class="avatar" src="/img/road.png" />
</a>
<div class="author">
    <span>imfan</span>
</div>

<!--个人联系方式icon-->
<div class="icon">
    
        
        <a title="github" href="https://github.com/im-fan" target="_blank">
            
                <svg class="iconfont-svg" aria-hidden="true">
                    <use xlink:href="#icon-github"></use>
                </svg>
            
        </a>
        
    
        
        <a title="email" href="mailto:wyf3634@163.com" target="_blank">
            
                <svg class="iconfont-svg" aria-hidden="true">
                    <use xlink:href="#icon-email"></use>
                </svg>
            
        </a>
        
    
</div>






<ul>
    <li><div class="all active" data-rel="全部文章">全部文章<small>(63)</small></div></li>
    
        
            
            <li><div data-rel="前端">前端<small>(1)</small></div>
                
            </li>
            
        
    
        
            
            <li><div data-rel="后端"><i class="fold iconfont icon-right"></i>后端<small>(27)</small></div>
                
                    <ul class="sub hide">
                        
                        <li><div data-rel="后端<--->服务治理">服务治理<small>(5)</small></div>
                            
                        </li>
                        
                        <li><div data-rel="后端<--->高并发">高并发<small>(1)</small></div>
                            
                        </li>
                        
                        <li><div data-rel="后端<--->工具">工具<small>(5)</small></div>
                            
                        </li>
                        
                        <li><div data-rel="后端<--->接口文档">接口文档<small>(1)</small></div>
                            
                        </li>
                        
                        <li><div data-rel="后端<--->框架">框架<small>(4)</small></div>
                            
                        </li>
                        
                        <li><div data-rel="后端<--->三方集成">三方集成<small>(1)</small></div>
                            
                        </li>
                        
                        <li><div data-rel="后端<--->事件推送">事件推送<small>(1)</small></div>
                            
                        </li>
                        
                        <li><div data-rel="后端<--->数据结构与算法">数据结构与算法<small>(1)</small></div>
                            
                        </li>
                        
                        <li><div data-rel="后端<--->线程池">线程池<small>(1)</small></div>
                            
                        </li>
                        
                        <li><div data-rel="后端<--->项目编译">项目编译<small>(1)</small></div>
                            
                        </li>
                        
                        <li><div data-rel="后端<--->消息队列">消息队列<small>(3)</small></div>
                            
                        </li>
                        
                        <li><div data-rel="后端<--->io">io<small>(1)</small></div>
                            
                        </li>
                        
                        <li><div data-rel="后端<--->ognl表达式">ognl表达式<small>(1)</small></div>
                            
                        </li>
                        
                    </ul>
                
            </li>
            
        
    
        
            
            <li><div data-rel="测试">测试<small>(1)</small></div>
                
            </li>
            
        
    
        
            
            <li><div data-rel="存储">存储<small>(6)</small></div>
                
            </li>
            
        
    
        
            
            <li><div data-rel="运维">运维<small>(8)</small></div>
                
            </li>
            
        
    
        
            
            <li><div data-rel="架构">架构<small>(5)</small></div>
                
            </li>
            
        
    
        
            
            <li><div data-rel="思考">思考<small>(4)</small></div>
                
            </li>
            
        
    
        
            
            <li><div data-rel="其他">其他<small>(4)</small></div>
                
            </li>
            
        
    
        
            
        
    
        
            
        
    
        
            
        
    
        
            
        
    
        
            
        
    
        
            
            <li><div data-rel="名人名言">名人名言<small>(1)</small></div>
                
            </li>
            
        
    
        
            
        
    
        
            
        
    
        
            
        
    
        
            
        
    
        
            
            <li><div data-rel="线上问题">线上问题<small>(1)</small></div>
                
            </li>
            
        
    
        
            
        
    
        
            
        
    
        
            
            <li><div data-rel="杂记">杂记<small>(1)</small></div>
                
            </li>
            
        
    
        
            
            <li><div data-rel="AI">AI<small>(3)</small></div>
                
            </li>
            
        
    
        
            
        
    
        
            
            <li><div data-rel="LLM">LLM<small>(1)</small></div>
                
            </li>
            
        
    
        
            
        
    
</ul>

<!-- 左边导航栏 关于&友链 -->
<div class="left-bottom">
    <div class="menus">
    
    
    </div>
    <div>
    
    </div>
</div>

<input type="hidden" id="yelog_site_posts_number" value="63">
<input type="hidden" id="yelog_site_word_count" value="74.5k">
<div style="display: none">
    <span id="busuanzi_value_site_uv"></span>
    <span id="busuanzi_value_site_pv"></span>
</div>

    </div>
    <div class="nav-right">
        <div class="friends-area">
    <div class="friends-title">
        友情链接
        <i class="iconfont icon-left"></i>
    </div>
    <div class="friends-content">
        <ul>
            
            <li><a target="_blank" href="http://yelog.org/">叶落阁</a></li>
            
            <li><a target="_blank" href="https://www.infoq.cn/">InfoQ</a></li>
            
            <li><a target="_blank" href="https://www.csdn.net/">CSDN</a></li>
            
            <li><a target="_blank" href="https://www.liaoxuefeng.com/">廖雪峰的官方网站</a></li>
            
        </ul>
    </div>
</div>
        <div class="title-list">
    <div class="right-top">
        <div id="default-panel">
            <i class="iconfont icon-search" data-title="搜索 快捷键 i"></i>
            <div class="right-title">全部文章</div>
            <i class="iconfont icon-file-tree" data-title="切换到大纲视图 快捷键 w"></i>
        </div>
        <div id="search-panel">
            <i class="iconfont icon-left" data-title="返回"></i>
            <input id="local-search-input" />
            <label class="border-line" for="input"></label>
            <i class="iconfont icon-case-sensitive" data-title="大小写敏感"></i>
            <i class="iconfont icon-tag" data-title="标签"></i>
        </div>
        <div id="outline-panel" style="display: none">
            <div class="right-title">大纲</div>
            <i class="iconfont icon-list" data-title="切换到文章列表"></i>
        </div>
    </div>

    <div class="tags-list">
    <input id="tag-search" />
    <div class="tag-wrapper">
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>动态配置</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>分布式锁</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>高并发</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>技术文档</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>接口文档</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>三方集成</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>设计模式</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>事件推送</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>数据结构与算法</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>思维</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>线程池</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>线上问题</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>项目编译</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>写作</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>杂记</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>摘要</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>注册中心</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>总结方法论</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>AI</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>ai相关</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>AIGC,SD,StableDiffusion</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>arthas</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>cache</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>canal</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>COLA</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>DDD</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>devops</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>docker</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>elasticsearch</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>es</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>eureka</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>gateway</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>io</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>istio</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>json类型</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>kafka</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>ldap</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>LLM</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>message</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>mysql</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>nacos</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>nginx</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>oauth2</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>ognl</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>pulsar</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>rocketmq</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>shell命令</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>skywalking</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>SPI</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>springboot</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>SpringFramework</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>test</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>tool</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>url</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>utils</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>vue</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>zookeeper</a>
            </li>
        
    </div>

</div>

    
    <div id="local-search-result">

    </div>
    
    <nav id="title-list-nav">
        
        <a id="top" class="全部文章 其他 "
           href="/2023/08/08/other/url/"
           data-tag="url"
           data-author="" >
            <span class="post-title" title="有趣的链接">有趣的链接</span>
            <span class="post-date" title="2023-08-08 09:20:00">2023/08/08</span>
        </a>
        
        <a  class="全部文章 后端 事件推送 "
           href="/2023/12/06/backend/spring/springboot-event-stream/"
           data-tag="事件推送"
           data-author="" >
            <span class="post-title" title="SpringBoot-EventStream">SpringBoot-EventStream</span>
            <span class="post-date" title="2023-12-06 15:10:00">2023/12/06</span>
        </a>
        
        <a  class="全部文章 AI "
           href="/2023/09/06/ai/gc/stable-diffusion-01/"
           data-tag="AIGC,SD,StableDiffusion"
           data-author="" >
            <span class="post-title" title="Stable Diffusion Web UI(一)-部署">Stable Diffusion Web UI(一)-部署</span>
            <span class="post-date" title="2023-09-06 00:00:00">2023/09/06</span>
        </a>
        
        <a  class="全部文章 AI "
           href="/2023/09/06/ai/gc/stable-diffusion-02/"
           data-tag="AIGC,SD,StableDiffusion"
           data-author="" >
            <span class="post-title" title="Stable Diffusion Web UI(二)-资源">Stable Diffusion Web UI(二)-资源</span>
            <span class="post-date" title="2023-09-06 00:00:00">2023/09/06</span>
        </a>
        
        <a  class="全部文章 AI "
           href="/2023/04/11/ai/gpt/gpt/"
           data-tag="ai相关"
           data-author="" >
            <span class="post-title" title="GPT-AI介绍">GPT-AI介绍</span>
            <span class="post-date" title="2023-04-11 00:00:00">2023/04/11</span>
        </a>
        
        <a  class="全部文章 LLM "
           href="/2023/04/11/ai/llm/llm/"
           data-tag="AI,LLM"
           data-author="" >
            <span class="post-title" title="LLM-AI介绍">LLM-AI介绍</span>
            <span class="post-date" title="2023-04-11 00:00:00">2023/04/11</span>
        </a>
        
        <a  class="全部文章 线上问题 "
           href="/2023/03/29/error/es-error/"
           data-tag="线上问题,elasticsearch"
           data-author="" >
            <span class="post-title" title="线上问题处理过程-ES">线上问题处理过程-ES</span>
            <span class="post-date" title="2023-03-29 10:30:00">2023/03/29</span>
        </a>
        
        <a  class="全部文章 后端 服务治理 "
           href="/2023/03/16/backend/service/eureka/eureka-2/"
           data-tag="注册中心,eureka"
           data-author="" >
            <span class="post-title" title="Eureka源码学习笔记(二)">Eureka源码学习笔记(二)</span>
            <span class="post-date" title="2023-03-16 17:10:00">2023/03/16</span>
        </a>
        
        <a  class="全部文章 后端 服务治理 "
           href="/2023/03/16/backend/service/eureka/eureka/"
           data-tag="注册中心,eureka"
           data-author="" >
            <span class="post-title" title="Eureka源码学习笔记汇总">Eureka源码学习笔记汇总</span>
            <span class="post-date" title="2023-03-16 17:10:00">2023/03/16</span>
        </a>
        
        <a  class="全部文章 其他 "
           href="/2022/11/19/other/markdown/"
           data-tag="tool"
           data-author="" >
            <span class="post-title" title="Markdown画图">Markdown画图</span>
            <span class="post-date" title="2022-11-19 14:50:00">2022/11/19</span>
        </a>
        
        <a  class="全部文章 后端 服务治理 "
           href="/2022/09/28/backend/service/eureka/eureka-1/"
           data-tag="注册中心,eureka"
           data-author="" >
            <span class="post-title" title="Eureka源码学习笔记(一)">Eureka源码学习笔记(一)</span>
            <span class="post-date" title="2022-09-28 16:50:00">2022/09/28</span>
        </a>
        
        <a  class="全部文章 存储 "
           href="/2022/06/01/backend/storage/mysql-json/"
           data-tag="mysql,json类型"
           data-author="" >
            <span class="post-title" title="MySQL相关-json类型">MySQL相关-json类型</span>
            <span class="post-date" title="2022-06-01 15:20:00">2022/06/01</span>
        </a>
        
        <a  class="全部文章 后端 ognl表达式 "
           href="/2022/05/25/backend/other/ognl/"
           data-tag="ognl"
           data-author="" >
            <span class="post-title" title="Ognl表达式">Ognl表达式</span>
            <span class="post-date" title="2022-05-25 15:40:00">2022/05/25</span>
        </a>
        
        <a  class="全部文章 后端 消息队列 "
           href="/2022/05/23/backend/mq/pulsar/"
           data-tag="message,pulsar"
           data-author="" >
            <span class="post-title" title="Pulsar消息队列">Pulsar消息队列</span>
            <span class="post-date" title="2022-05-23 10:20:00">2022/05/23</span>
        </a>
        
        <a  class="全部文章 运维 "
           href="/2022/03/08/devops/shell/"
           data-tag="shell命令"
           data-author="" >
            <span class="post-title" title="Shell命令记录">Shell命令记录</span>
            <span class="post-date" title="2022-03-08 11:13:00">2022/03/08</span>
        </a>
        
        <a  class="全部文章 存储 "
           href="/2022/02/15/backend/storage/es/"
           data-tag="es"
           data-author="" >
            <span class="post-title" title="ES官方文档笔记">ES官方文档笔记</span>
            <span class="post-date" title="2022-02-15 13:38:00">2022/02/15</span>
        </a>
        
        <a  class="全部文章 后端 数据结构与算法 "
           href="/2022/01/13/backend/java/algorithm/book1/"
           data-tag="数据结构与算法"
           data-author="" >
            <span class="post-title" title="大话数据结构-摘要">大话数据结构-摘要</span>
            <span class="post-date" title="2022-01-13 16:54:00">2022/01/13</span>
        </a>
        
        <a  class="全部文章 名人名言 "
           href="/2022/01/10/thinking/famous/"
           data-tag="思维"
           data-author="" >
            <span class="post-title" title="名人名言和一些思维模型">名人名言和一些思维模型</span>
            <span class="post-date" title="2022-01-10 14:44:10">2022/01/10</span>
        </a>
        
        <a  class="全部文章 思考 "
           href="/2022/01/10/thinking/design/"
           data-tag="总结方法论"
           data-author="" >
            <span class="post-title" title="工作相关">工作相关</span>
            <span class="post-date" title="2022-01-10 14:44:10">2022/01/10</span>
        </a>
        
        <a  class="全部文章 思考 "
           href="/2022/01/10/thinking/write/"
           data-tag="写作"
           data-author="" >
            <span class="post-title" title="写作思路和技巧">写作思路和技巧</span>
            <span class="post-date" title="2022-01-10 14:44:10">2022/01/10</span>
        </a>
        
        <a  class="全部文章 后端 接口文档 "
           href="/2021/11/25/backend/other/swagger/"
           data-tag="接口文档"
           data-author="" >
            <span class="post-title" title="集成SwaggerUI">集成SwaggerUI</span>
            <span class="post-date" title="2021-11-25 10:00:00">2021/11/25</span>
        </a>
        
        <a  class="全部文章 后端 高并发 "
           href="/2021/11/22/backend/java/thread/concurrent/"
           data-tag="高并发"
           data-author="" >
            <span class="post-title" title="高并发相关">高并发相关</span>
            <span class="post-date" title="2021-11-22 20:06:00">2021/11/22</span>
        </a>
        
        <a  class="全部文章 测试 "
           href="/2021/11/15/test/test/"
           data-tag="test"
           data-author="" >
            <span class="post-title" title="测试相关">测试相关</span>
            <span class="post-date" title="2021-11-15 17:51:54">2021/11/15</span>
        </a>
        
        <a  class="全部文章 运维 "
           href="/2021/10/13/devops/arthas/"
           data-tag="arthas"
           data-author="" >
            <span class="post-title" title="Arthas-问题排查工具">Arthas-问题排查工具</span>
            <span class="post-date" title="2021-10-13 09:17:00">2021/10/13</span>
        </a>
        
        <a  class="全部文章 后端 io "
           href="/2021/08/11/backend/java/netty/io/"
           data-tag="io"
           data-author="" >
            <span class="post-title" title="IO">IO</span>
            <span class="post-date" title="2021-08-11 09:31:00">2021/08/11</span>
        </a>
        
        <a  class="全部文章 后端 三方集成 "
           href="/2021/08/04/backend/other/jimu-report/"
           data-tag="三方集成"
           data-author="" >
            <span class="post-title" title="集成Jimu报表">集成Jimu报表</span>
            <span class="post-date" title="2021-08-04 18:28:22">2021/08/04</span>
        </a>
        
        <a  class="全部文章 后端 框架 "
           href="/2021/07/26/backend/spring/framework/springframework-2/"
           data-tag="SpringFramework"
           data-author="" >
            <span class="post-title" title="SpringFramework源码学习">SpringFramework源码学习</span>
            <span class="post-date" title="2021-07-26 15:05:00">2021/07/26</span>
        </a>
        
        <a  class="全部文章 存储 "
           href="/2021/07/20/backend/storage/mysql/"
           data-tag="mysql"
           data-author="" >
            <span class="post-title" title="MySQL相关-知识点">MySQL相关-知识点</span>
            <span class="post-date" title="2021-07-20 09:45:00">2021/07/20</span>
        </a>
        
        <a  class="全部文章 后端 框架 "
           href="/2021/06/26/backend/spring/framework/springframework-1/"
           data-tag="SpringFramework"
           data-author="" >
            <span class="post-title" title="SpringFramework源码编译">SpringFramework源码编译</span>
            <span class="post-date" title="2021-06-26 20:00:00">2021/06/26</span>
        </a>
        
        <a  class="全部文章 后端 框架 "
           href="/2021/06/15/backend/spring/springcloud-gateway/"
           data-tag="gateway"
           data-author="" >
            <span class="post-title" title="SpringClougGateway">SpringClougGateway</span>
            <span class="post-date" title="2021-06-15 14:16:00">2021/06/15</span>
        </a>
        
        <a  class="全部文章 运维 "
           href="/2021/05/19/devops/skywalking/"
           data-tag="skywalking"
           data-author="" >
            <span class="post-title" title="调用链监控-skywalking">调用链监控-skywalking</span>
            <span class="post-date" title="2021-05-19 16:52:25">2021/05/19</span>
        </a>
        
        <a  class="全部文章 运维 "
           href="/2021/05/18/devops/istio/"
           data-tag="istio"
           data-author="" >
            <span class="post-title" title="istio">istio</span>
            <span class="post-date" title="2021-05-18 16:30:00">2021/05/18</span>
        </a>
        
        <a  class="全部文章 前端 "
           href="/2021/04/28/frontend/vue/"
           data-tag="vue"
           data-author="" >
            <span class="post-title" title="vue">vue</span>
            <span class="post-date" title="2021-04-28 11:44:02">2021/04/28</span>
        </a>
        
        <a  class="全部文章 运维 "
           href="/2021/04/16/devops/docker/"
           data-tag="docker"
           data-author="" >
            <span class="post-title" title="运维相关">运维相关</span>
            <span class="post-date" title="2021-04-16 14:19:25">2021/04/16</span>
        </a>
        
        <a  class="全部文章 后端 服务治理 "
           href="/2021/04/13/backend/service/nacos/"
           data-tag="nacos,动态配置,注册中心"
           data-author="" >
            <span class="post-title" title="nacos">nacos</span>
            <span class="post-date" title="2021-04-13 10:56:52">2021/04/13</span>
        </a>
        
        <a  class="全部文章 运维 "
           href="/2021/04/05/devops/nginx/"
           data-tag="nginx"
           data-author="" >
            <span class="post-title" title="nginx">nginx</span>
            <span class="post-date" title="2021-04-05 10:26:05">2021/04/05</span>
        </a>
        
        <a  class="全部文章 后端 框架 "
           href="/2021/03/22/backend/spring/spring-boot/"
           data-tag="springboot"
           data-author="" >
            <span class="post-title" title="SpringBoot">SpringBoot</span>
            <span class="post-date" title="2021-03-22 09:44:01">2021/03/22</span>
        </a>
        
        <a  class="全部文章 后端 工具 "
           href="/2021/03/20/backend/java/utils/convert/orika/"
           data-tag="utils"
           data-author="" >
            <span class="post-title" title="对象转换工具-Orika">对象转换工具-Orika</span>
            <span class="post-date" title="2021-03-20 14:15:00">2021/03/20</span>
        </a>
        
        <a  class="全部文章 运维 "
           href="/2021/02/18/devops/ldap/"
           data-tag="ldap"
           data-author="" >
            <span class="post-title" title="LDAP学习笔记">LDAP学习笔记</span>
            <span class="post-date" title="2021-02-18 14:25:55">2021/02/18</span>
        </a>
        
        <a  class="全部文章 运维 "
           href="/2021/02/09/devops/check/"
           data-tag="devops"
           data-author="" >
            <span class="post-title" title="服务常见问题排查">服务常见问题排查</span>
            <span class="post-date" title="2021-02-09 17:08:25">2021/02/09</span>
        </a>
        
        <a  class="全部文章 后端 线程池 "
           href="/2021/02/09/backend/java/thread/threadPool/"
           data-tag="线程池"
           data-author="" >
            <span class="post-title" title="ThreadPool详解">ThreadPool详解</span>
            <span class="post-date" title="2021-02-09 14:12:45">2021/02/09</span>
        </a>
        
        <a  class="全部文章 后端 消息队列 "
           href="/2021/02/03/backend/mq/kafka/"
           data-tag="message,kafka"
           data-author="" >
            <span class="post-title" title="SpringBoot集成Kafka">SpringBoot集成Kafka</span>
            <span class="post-date" title="2021-02-03 16:06:00">2021/02/03</span>
        </a>
        
        <a  class="全部文章 后端 消息队列 "
           href="/2021/02/03/backend/mq/rocketmq/"
           data-tag="message,rocketmq"
           data-author="" >
            <span class="post-title" title="RocketMQ相关文档">RocketMQ相关文档</span>
            <span class="post-date" title="2021-02-03 16:06:00">2021/02/03</span>
        </a>
        
        <a  class="全部文章 存储 "
           href="/2021/02/02/backend/storage/redis/"
           data-tag="cache"
           data-author="" >
            <span class="post-title" title="Redis学习笔记">Redis学习笔记</span>
            <span class="post-date" title="2021-02-02 19:59:00">2021/02/02</span>
        </a>
        
        <a  class="全部文章 后端 项目编译 "
           href="/2021/01/21/backend/java/build/gradle/"
           data-tag="项目编译"
           data-author="" >
            <span class="post-title" title="Gradle学习笔记">Gradle学习笔记</span>
            <span class="post-date" title="2021-01-21 13:24:22">2021/01/21</span>
        </a>
        
        <a  class="全部文章 架构 "
           href="/2020/12/25/framework/design/uml/"
           data-tag="技术文档"
           data-author="" >
            <span class="post-title" title="技术文档">技术文档</span>
            <span class="post-date" title="2020-12-25 18:57:00">2020/12/25</span>
        </a>
        
        <a  class="全部文章 架构 "
           href="/2020/12/15/framework/cola/"
           data-tag="COLA"
           data-author="" >
            <span class="post-title" title="领域建模&amp;业务建模方法论">领域建模&amp;业务建模方法论</span>
            <span class="post-date" title="2020-12-15 16:24:00">2020/12/15</span>
        </a>
        
        <a  class="全部文章 后端 工具 "
           href="/2020/12/10/backend/java/utils/mybatis-plus/"
           data-tag="utils"
           data-author="" >
            <span class="post-title" title="MybatisPlus使用笔记">MybatisPlus使用笔记</span>
            <span class="post-date" title="2020-12-10 12:00:00">2020/12/10</span>
        </a>
        
        <a  class="全部文章 架构 "
           href="/2020/11/17/framework/oauth2/"
           data-tag="oauth2"
           data-author="" >
            <span class="post-title" title="OAuth2学习笔记">OAuth2学习笔记</span>
            <span class="post-date" title="2020-11-17 09:58:26">2020/11/17</span>
        </a>
        
        <a  class="全部文章 后端 "
           href="/2020/11/11/backend/java/spi/"
           data-tag="SPI"
           data-author="" >
            <span class="post-title" title="SPI-Java内置服务发现机制">SPI-Java内置服务发现机制</span>
            <span class="post-date" title="2020-11-11 19:30:00">2020/11/11</span>
        </a>
        
        <a  class="全部文章 后端 工具 "
           href="/2020/11/11/backend/java/utils/swagger/"
           data-tag="utils"
           data-author="" >
            <span class="post-title" title="Java解析Swagger文档接口及参数">Java解析Swagger文档接口及参数</span>
            <span class="post-date" title="2020-11-11 19:30:00">2020/11/11</span>
        </a>
        
        <a  class="全部文章 后端 服务治理 "
           href="/2020/10/29/backend/service/zookeeper/"
           data-tag="注册中心,zookeeper,分布式锁"
           data-author="" >
            <span class="post-title" title="Zookeeper简介">Zookeeper简介</span>
            <span class="post-date" title="2020-10-29 15:40:46">2020/10/29</span>
        </a>
        
        <a  class="全部文章 后端 工具 "
           href="/2020/10/20/backend/java/utils/excel/"
           data-tag="utils"
           data-author="" >
            <span class="post-title" title="EasyExcel使用遇到的问题">EasyExcel使用遇到的问题</span>
            <span class="post-date" title="2020-10-20 17:22:53">2020/10/20</span>
        </a>
        
        <a  class="全部文章 架构 "
           href="/2020/10/09/framework/ddd/"
           data-tag="DDD"
           data-author="" >
            <span class="post-title" title="DDD-领域驱动设计">DDD-领域驱动设计</span>
            <span class="post-date" title="2020-10-09 16:51:54">2020/10/09</span>
        </a>
        
        <a  class="全部文章 架构 "
           href="/2020/10/02/framework/design-model/"
           data-tag="设计模式"
           data-author="" >
            <span class="post-title" title="14种常用设计模式">14种常用设计模式</span>
            <span class="post-date" title="2020-10-02 15:51:46">2020/10/02</span>
        </a>
        
        <a  class="全部文章 存储 "
           href="/2020/10/02/backend/storage/canal/"
           data-tag="canal"
           data-author="" >
            <span class="post-title" title="Canal服务搭建">Canal服务搭建</span>
            <span class="post-date" title="2020-10-02 15:51:46">2020/10/02</span>
        </a>
        
        <a  class="全部文章 存储 "
           href="/2020/10/02/backend/storage/mysql-other/"
           data-tag="mysql"
           data-author="" >
            <span class="post-title" title="MySQL相关-常用语句">MySQL相关-常用语句</span>
            <span class="post-date" title="2020-10-02 15:51:46">2020/10/02</span>
        </a>
        
        <a  class="全部文章 后端 工具 "
           href="/2020/10/02/backend/java/utils/convert/map-struct/"
           data-tag="utils"
           data-author="" >
            <span class="post-title" title="对象转换工具-MapStruct">对象转换工具-MapStruct</span>
            <span class="post-date" title="2020-10-02 15:51:46">2020/10/02</span>
        </a>
        
        <a  class="全部文章 思考 "
           href="/2020/10/02/thinking/book/"
           data-tag="思维"
           data-author="" >
            <span class="post-title" title="阅读">阅读</span>
            <span class="post-date" title="2020-10-02 14:44:10">2020/10/02</span>
        </a>
        
        <a  class="全部文章 杂记 "
           href="/2020/10/02/thinking/something/"
           data-tag="杂记"
           data-author="" >
            <span class="post-title" title="杂记">杂记</span>
            <span class="post-date" title="2020-10-02 14:44:10">2020/10/02</span>
        </a>
        
        <a  class="全部文章 思考 "
           href="/2020/10/02/thinking/abstract/"
           data-tag="摘要"
           data-author="" >
            <span class="post-title" title="阅读摘要">阅读摘要</span>
            <span class="post-date" title="2020-10-02 14:44:10">2020/10/02</span>
        </a>
        
        <a  class="全部文章 其他 "
           href="/2020/10/02/other/software/"
           data-tag="tool"
           data-author="" >
            <span class="post-title" title="软件推荐">软件推荐</span>
            <span class="post-date" title="2020-10-02 14:34:06">2020/10/02</span>
        </a>
        
        <a  class="全部文章 其他 "
           href="/2020/09/30/other/hexo/"
           data-tag="tool"
           data-author="" >
            <span class="post-title" title="Hexo搭建博客">Hexo搭建博客</span>
            <span class="post-date" title="2020-09-30 14:51:20">2020/09/30</span>
        </a>
        
        <div id="no-item-tips">

        </div>
    </nav>
    <div id="outline-list">
    </div>
</div>
    </div>
    <!-- <div class="hide-list">
        <div class="semicircle" data-title="切换全屏 快捷键 s">
            <div class="brackets first"><</div>
            <div class="brackets">&gt;</div>
        </div>
    </div> -->
</aside>
<div id="post">
    <div class="pjax">
        <article id="post-backend/service/eureka/eureka-1" class="article article-type-post" itemscope itemprop="blogPost">
    
        <h1 class="article-title">Eureka源码学习笔记(一)</h1>
    
    <div class="article-meta">
        
        
        
        <span class="book">
            <i class="iconfont icon-category"></i>
            
            
            <a  data-rel="后端">后端</a> > 
            
            <a  data-rel="后端&lt;---&gt;服务治理">服务治理</a>
            
        </span>
        
        
        <span class="tag">
            <i class="iconfont icon-tag"></i>
            
            <a class="color5">注册中心</a>
            
            <a class="color2">eureka</a>
            
        </span>
        
    </div>
    <div class="article-meta">
        
            发布时间 : <time class="date" title='最后更新: 2023-03-16 17:14:16'>2022-09-28 16:50</time>
        
    </div>
    <div class="article-meta">
        
        <span>字数:3.9k</span>
        
        
        <!-- <span id="busuanzi_container_page_pv">
            阅读 :<span id="busuanzi_value_page_pv">
                <span class="count-comment">
                    <span class="spinner">
                      <div class="cube1"></div>
                      <div class="cube2"></div>
                    </span>
                </span>
            </span>
        </span> -->
        
        
    </div>
    
    <div class="toc-ref">
    
        <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%B8%80%E3%80%81Eureka%E6%98%AF%E4%BB%80%E4%B9%88"><span class="toc-text">一、Eureka是什么</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1-4R%E6%8B%86%E8%A7%A3"><span class="toc-text">1. 4R拆解</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-1-%E9%A1%B6%E5%B1%82%E7%BB%93%E6%9E%84"><span class="toc-text">1.1.顶层结构</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-2-%E7%BB%84%E6%88%90%E8%A7%92%E8%89%B2"><span class="toc-text">1.2.组成角色</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-3-%E8%A7%92%E8%89%B2%E5%85%B3%E7%B3%BB"><span class="toc-text">1.3.角色关系</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-4-%E8%BF%90%E4%BD%9C%E8%A7%84%E5%BE%8B"><span class="toc-text">1.4.运作规律</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-%E5%89%8D%E6%9C%9F%E5%87%86%E5%A4%87"><span class="toc-text">2.前期准备</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%BA%8C%E3%80%81%E6%9C%8D%E5%8A%A1%E5%90%AF%E5%8A%A8%E6%BA%90%E7%A0%81%E6%8B%86%E8%A7%A3"><span class="toc-text">二、服务启动源码拆解</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1-%E5%85%A5%E5%8F%A3%E5%88%86%E6%9E%90"><span class="toc-text">1.入口分析</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-%E5%90%AF%E5%8A%A8%E8%BF%87%E7%A8%8B%E5%BA%8F%E5%88%97%E5%9B%BE"><span class="toc-text">2.启动过程序列图</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#2-1-%E4%B8%BB%E8%A6%81%E6%B5%81%E7%A8%8B"><span class="toc-text">2.1 主要流程</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-2-%E6%A0%B8%E5%BF%83%E6%B5%81%E7%A8%8B"><span class="toc-text">2.2 核心流程</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-EurekaServerAutoConfiguration%E9%85%8D%E7%BD%AE%E7%B1%BB%E8%AF%A6%E8%A7%A3"><span class="toc-text">3.EurekaServerAutoConfiguration配置类详解</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-EurekaServerInitializerConfiguration%E6%BA%90%E7%A0%81"><span class="toc-text">4.EurekaServerInitializerConfiguration源码</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#4-1-EurekaServerBootstrap%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90"><span class="toc-text">4.1.EurekaServerBootstrap源码解析</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#4-1-1-EurekaServerContext%E8%AF%A6%E8%A7%A3"><span class="toc-text">4.1.1.EurekaServerContext详解</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-2-peerEurekaNodes-start-%E5%88%86%E6%9E%90"><span class="toc-text">4.2.peerEurekaNodes.start()分析</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-3-registry-init-%E5%88%86%E6%9E%90"><span class="toc-text">4.3.registry.init()分析</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#5-%E5%90%8C%E6%AD%A5%E9%9B%86%E7%BE%A4%E8%8A%82%E7%82%B9%E6%B3%A8%E5%86%8C%E8%A1%A8-PeerAwareInstanceRegistry-syncUp"><span class="toc-text">5.同步集群节点注册表 PeerAwareInstanceRegistry.syncUp()</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#6-PeerAwareInstanceRegistry-openForTraffic"><span class="toc-text">6.PeerAwareInstanceRegistry.openForTraffic()</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#7-%E5%90%AF%E5%8A%A8%E8%BF%87%E7%A8%8B%E6%80%BB%E7%BB%93"><span class="toc-text">7.启动过程总结</span></a></li></ol></li></ol>
    
<style>
    .left-col .switch-btn,
    .left-col .switch-area {
        display: none;
    }
    .toc-level-3 i,
    .toc-level-3 ol {
        display: none !important;
    }
</style>
</div>
    
    <div class="article-entry" itemprop="articleBody">
      
        <blockquote>
<p>EurekaServer启动流程,包括Eureka服务注册、心跳、注册表同步、服务剔除等流程<br>基于4R架构理论拆解: 顶层结构(Rank) –&gt; 组成角色(Role) –&gt; 角色关系(Relation) –&gt; 运作规则(Rule)</p>
</blockquote>
<h1 id="一、Eureka是什么"><a href="#一、Eureka是什么" class="headerlink" title="一、Eureka是什么"></a>一、Eureka是什么</h1><pre><code class="textmate">Eureka是一个基于REST协议(Representational State Transfer表述性状态转移)的服务,
Eureka还附带了一个基于java的客户端组件Eureka client，它使与服务的交互更加容易。
客户端还有一个内置的负载均衡器，用于进行基本的轮询负载平衡。
Eureka填补了中间层负载平衡的需求

tips: REST,资源(URI)表述性状态转移 
    状态转移就是客户端通过一系列请求动作，推动服务端的资源状态发生变化，资源的状态可以在「创建-修改-查看-删除」之间转移。
</code></pre>
<p><img src="https://raw.githubusercontent.com/im-fan/fan-pic/release/imageseurek.png" alt="eureak组件图"></p>
<h2 id="1-4R拆解"><a href="#1-4R拆解" class="headerlink" title="1. 4R拆解"></a>1. 4R拆解</h2><h3 id="1-1-顶层结构"><a href="#1-1-顶层结构" class="headerlink" title="1.1.顶层结构"></a>1.1.顶层结构</h3><ul>
<li>Eureka Server：Eureka 服务端</li>
<li>Eureka Client：Eureka 客户端</li>
</ul>
<h3 id="1-2-组成角色"><a href="#1-2-组成角色" class="headerlink" title="1.2.组成角色"></a>1.2.组成角色</h3><ul>
<li>Eureka Server：Eureka 服务端</li>
<li>Eureka Client：Eureka 客户端<ul>
<li>Application Provider： 服务生产者</li>
<li>Application Consumer：服务消费者</li>
</ul>
</li>
</ul>
<h3 id="1-3-角色关系"><a href="#1-3-角色关系" class="headerlink" title="1.3.角色关系"></a>1.3.角色关系</h3><pre><code class="textmate">EurekaServer维护注册表、主动从注册表中删除超时未续约的EurekaClient
EurekaClient向EurekaServer注册自己的服务、发心跳、下线、获取服务列表
ApplicationProvider提供服务
ApplicationConsumer消费服务
</code></pre>
<h3 id="1-4-运作规律"><a href="#1-4-运作规律" class="headerlink" title="1.4.运作规律"></a>1.4.运作规律</h3><pre><code class="textmate">服务注册 Register: Client 端主动向 Server 端注册。
心跳续约 Renew: Client 默认会每隔30秒发送一次心跳到 Server 来完成续约。
主动下线 Cancel：Client 端在停机时（正常停止）主动向 Server 发送下线，提示Server端下掉自己的服务
获取服务列表 Get Registry：Client 从 Server 获取注册表，并将其缓存在本地。缓存信息默认每 30s 更新一次。
注册表同步 Replicate：多个 Server 之间通过 P2P 复制的方式完成服务注册表的同步。
服务剔除 Eviction：在默认的情况下，当 Client 连续 90 秒没有向 Server 发送服务续约，Server 会将该 Client 从服务注册列表删除。
</code></pre>
<h2 id="2-前期准备"><a href="#2-前期准备" class="headerlink" title="2.前期准备"></a>2.前期准备</h2><ul>
<li><a target="_blank" rel="noopener" href="https://github.com/spring-cloud/spring-cloud-netflix">spring-cloud-netflix源码地址</a></li>
<li>SequenceDiagram Idea插件</li>
</ul>
<h1 id="二、服务启动源码拆解"><a href="#二、服务启动源码拆解" class="headerlink" title="二、服务启动源码拆解"></a>二、服务启动源码拆解</h1><h2 id="1-入口分析"><a href="#1-入口分析" class="headerlink" title="1.入口分析"></a>1.入口分析</h2><blockquote>
<p>以@EnableEurekaServer作为切入点开始分析</p>
</blockquote>
<pre><code class="java">//1.作用: 注入EurekaServerMarkerConfigurationMarker.Marker对象
@Target(ElementType.TYPE)
@Retention(RetentionPolicy.RUNTIME)
@Documented
@Import(EurekaServerMarkerConfiguration.class)
public @interface EnableEurekaServer &#123;
&#125;

@Configuration(proxyBeanMethods = false)
public class EurekaServerMarkerConfiguration &#123;

  @Bean
  public Marker eurekaServerMarkerBean() &#123;
    return new Marker();
  &#125;

  class Marker &#123;&#125;
&#125;

//2.作用: 加载配置、初始化EurekaServer相关类、启动服务
@Configuration(proxyBeanMethods = false)
@Import(EurekaServerInitializerConfiguration.class)
@ConditionalOnBean(EurekaServerMarkerConfiguration.Marker.class)
@EnableConfigurationProperties(&#123; EurekaDashboardProperties.class,
        InstanceRegistryProperties.class &#125;)
@PropertySource(&quot;classpath:/eureka/server.properties&quot;)
public class EurekaServerAutoConfiguration implements WebMvcConfigurer &#123;
&#125;

// 3.SpringCloud自动装配了EurekaServerAutoConfiguration
/** 
org.springframework.boot.autoconfigure.EnableAutoConfiguration=\
        org.springframework.cloud.netflix.eureka.server.EurekaServerAutoConfiguration
**/
</code></pre>
<ul>
<li>流程描述</li>
</ul>
<pre><code class="textmate">1.框架自动装配EnableAutoConfiguration
2.服务启动类添加@EnableEurekaServer,注入EurekaServerMarkerConfiguration.Marker
3.EurekaServerAutoConfiguration类的@ConditionalOnBean生效,EurekaServerAutoConfiguration开始初始化
</code></pre>
<h2 id="2-启动过程序列图"><a href="#2-启动过程序列图" class="headerlink" title="2.启动过程序列图"></a>2.启动过程序列图</h2><h3 id="2-1-主要流程"><a href="#2-1-主要流程" class="headerlink" title="2.1 主要流程"></a>2.1 主要流程</h3><pre class="mermaid">sequenceDiagram
    participant SpringCloud
    participant enable as @EnableEurekaServer
    participant auto as EurekaServerAutoConfiguration
    participant dashboard as EurekaDashboardProperties
    participant serverContext as DefaultEurekaServerContext
    participant node as PeerEurekaNodes
    participant registry as InstanceRegistryProperties
    participant FilterRegistrationBean
    participant Application
    participant EurekaServerConfigBeanConfiguration
    participant conf as EurekaServerInitializerConfiguration
    participant bootStrap as EurekaServerBootstrap

    SpringCloud->>auto: 1.框架自动装配 
    enable->>enable: 2.注入Marker对象Bean
    note over auto: 有Marker对象Bean时才注入此Bean
    note over registry: 对等注册表实例
  
    #配置加载
    par 3.加载配置
    auto->>dashboard: 3.1 加载配置(eureka.dashboard.*)
    activate auto
    auto->>registry: 3.2 加载配置(eureka.instance.registry.*)
    auto->>auto: 3.3 加载配置(/eureka/server.properties)
    deactivate auto
    end
  
    #EurekaServerAutoConfiguration中注入的Bean
    par 4.注入其他Bean
      note right of auto: eureka.dashboard.enabled=true才注入；提供服务端访问页面的接口
      auto->>auto: 4.1 注入EurekaController
  
      note right of auto: 复制客户端时附加过滤器
      auto->>auto: 4.2 注入ReplicationClientAdditionalFilters
    
    
      auto->>registry: 4.3 注入PeerAwareInstanceRegistry
    
      note over node: 可刷新的对等EureakNode
      auto->>node: 4.4 注入PeerEurekaNodes(集群的Server节点信息)
    
      auto->>+serverContext: 4.5 注入EurekaServerContext
    
      serverContext->>serverContext: 触发initialize()方法
      serverContext->>node: start()
      serverContext->>-registry: init()
    
      auto->>bootStrap: 4.6 new()(后续启动中使用)
      auto->>FilterRegistrationBean: 4.7 Jersey拦截器(开源RESTful框架)
      auto->>Application: 4.8 构建JerseyApplication
      auto->>EurekaServerConfigBeanConfiguration: 4.9 Eureka服务器配置Bean(以eureka.server开头的配置)
    end
  
    note over conf: 实现了SmartLifecycle,Bean初始化完成后执行start()
    auto->>conf: 5.导入EurekaServerInitializerConfiguration实例,启动成功[重要]</pre>

<h3 id="2-2-核心流程"><a href="#2-2-核心流程" class="headerlink" title="2.2 核心流程"></a>2.2 核心流程</h3><blockquote>
<p>EurekaServerInitializerConfiguration类初始流程</p>
</blockquote>
<pre class="mermaid">sequenceDiagram
    participant conf as EurekaServerInitializerConfiguration
    participant bootStrap as EurekaServerBootstrap
    participant serverContent as DefaultEurekaServerContext
    participant registry as InstanceRegistryProperties
    participant node as PeerEurekaNodes
    participant registry as PeerAwareInstanceRegistry
    participant availableEvent as EurekaRegistryAvailableEvent
    participant startEvent as EurekaServerStartedEvent
    participant instance as AbstractInstanceRegistry
    participant servlet as ServletContext
 
    conf->>conf: start(),异步线程执行以下流程
    conf->>bootStrap: contextInitialized()
  
    bootStrap->>bootStrap: 1.initEurekaEnvironment()
 
    bootStrap->>+registry: 2.syncUp()从其他节点获取注册信息,并注册到本地注册表中
    loop 默认重试5次
      registry->>registry: 从第二次循环开始,每次默认sleep30s
      note over registry: 获取EurekaClient应用及每个应用实例,注册到本Server上
      registry->>registry: 服务注册
      registry->>instance: 执行注册流程
      instance->>+instance: register()
    
      #注册流程
      instance->>instance: 添加读锁
      instance->>instance: 判断该实例是否在注册表中存在,不存在则注册实例
      instance->>instance: 判断该服务是否有实例ID，有更新否则新增
      instance->>instance: 添加队列数据、缓存失效
      registry->>-bootStrap: 返回数量
    end
    bootStrap->>registry: 4.openForTraffic()开放注册
    note right of conf: 调整每分钟更新节点的阈值,更新应用实例状态为UP、开启主动下线实例一步任务
    bootStrap->>bootStrap: EurekaMonitors.registerAllStats()
  
    conf->>availableEvent: 发布eureak注册表可用事件、eurekaServer服务状态运营状态改为true
    conf->>startEvent: 发布eureak服务启动事件
    
    serverContent->>servlet: 将EurekaServerContext类添加到servelt中</pre>

<h2 id="3-EurekaServerAutoConfiguration配置类详解"><a href="#3-EurekaServerAutoConfiguration配置类详解" class="headerlink" title="3.EurekaServerAutoConfiguration配置类详解"></a>3.EurekaServerAutoConfiguration配置类详解</h2><blockquote>
<p>主要作用是加载配置、注入其他配置类</p>
</blockquote>
<pre><code class="java">@Configuration(proxyBeanMethods = false)
/** 1.TODO【重要】启动EurekaServer服务、发布相关事件 **/
@Import(EurekaServerInitializerConfiguration.class)
/** 2.注入标记类 **/
@ConditionalOnBean(EurekaServerMarkerConfiguration.Marker.class)
/** 3.加载配置 **/
@EnableConfigurationProperties(&#123; EurekaDashboardProperties.class,
        InstanceRegistryProperties.class &#125;)
@PropertySource(&quot;classpath:/eureka/server.properties&quot;)
public class EurekaServerAutoConfiguration implements WebMvcConfigurer &#123;

    /**
     * List of packages containing Jersey resources required by the Eureka server.
     */
    private static final String[] EUREKA_PACKAGES = new String[] &#123;
            &quot;com.netflix.discovery&quot;, &quot;com.netflix.eureka&quot; &#125;;
    @Autowired
    private ApplicationInfoManager applicationInfoManager;
    @Autowired
    private EurekaServerConfig eurekaServerConfig;
    @Autowired
    private EurekaClientConfig eurekaClientConfig;
    @Autowired
    private EurekaClient eurekaClient;
    @Autowired
    private InstanceRegistryProperties instanceRegistryProperties;

    /** 提供服务端访问页面的接口 **/
    @Bean
    @ConditionalOnProperty(prefix = &quot;eureka.dashboard&quot;, name = &quot;enabled&quot;,
            matchIfMissing = true)
    public EurekaController eurekaController() &#123;
        return new EurekaController(this.applicationInfoManager);
    &#125;

    /** client实例注册 **/
    @Bean
    public PeerAwareInstanceRegistry peerAwareInstanceRegistry(
            ServerCodecs serverCodecs) &#123;
        this.eurekaClient.getApplications(); // force initialization
        return new InstanceRegistry(this.eurekaServerConfig, this.eurekaClientConfig,
                serverCodecs, this.eurekaClient,
                this.instanceRegistryProperties.getExpectedNumberOfClientsSendingRenews(),
                this.instanceRegistryProperties.getDefaultOpenForTrafficCount());
    &#125;

    /** 可刷新的eureka节点 **/
    @Bean
    @ConditionalOnMissingBean
    public PeerEurekaNodes peerEurekaNodes(PeerAwareInstanceRegistry registry,
            ServerCodecs serverCodecs,
            ReplicationClientAdditionalFilters replicationClientAdditionalFilters) &#123;
        return new RefreshablePeerEurekaNodes(registry, this.eurekaServerConfig,
                this.eurekaClientConfig, serverCodecs, this.applicationInfoManager,
                replicationClientAdditionalFilters);
    &#125;

    /** eureka服务上下文 **/
    @Bean
    @ConditionalOnMissingBean
    public EurekaServerContext eurekaServerContext(ServerCodecs serverCodecs,
            PeerAwareInstanceRegistry registry, PeerEurekaNodes peerEurekaNodes) &#123;
        return new DefaultEurekaServerContext(this.eurekaServerConfig, serverCodecs,
                registry, peerEurekaNodes, this.applicationInfoManager);
    &#125;

    /** 初始化Eureka-server,初始化服务节点并注册 **/
    @Bean
    public EurekaServerBootstrap eurekaServerBootstrap(PeerAwareInstanceRegistry registry,
            EurekaServerContext serverContext) &#123;
        return new EurekaServerBootstrap(this.applicationInfoManager,
                this.eurekaClientConfig, this.eurekaServerConfig, registry,
                serverContext);
    &#125;

    /** 配置拦截器，ServletContainer里面实现了jersey框架，通过他来实现eurekaServer对外的restFull接口 **/
    /** jersey框架 开源的RESTful框架, 实现了JAX-RS (JSR 311 &amp; JSR 339) 规范
     * Register the Jersey filter.
     * @param eurekaJerseyApp an &#123;@link Application&#125; for the filter to be registered
     * @return a jersey &#123;@link FilterRegistrationBean&#125;
     */
    @Bean
    public FilterRegistrationBean&lt;?&gt; jerseyFilterRegistration(
            javax.ws.rs.core.Application eurekaJerseyApp) &#123;
        FilterRegistrationBean&lt;Filter&gt; bean = new FilterRegistrationBean&lt;Filter&gt;();
        bean.setFilter(new ServletContainer(eurekaJerseyApp));
        bean.setOrder(Ordered.LOWEST_PRECEDENCE);
        bean.setUrlPatterns(
                Collections.singletonList(EurekaConstants.DEFAULT_PREFIX + &quot;/*&quot;));

        return bean;
    &#125;

    /**
     * 构建Jersey应用程序和Eureka服务器所需的所有资源。
     */
    @Bean
    public javax.ws.rs.core.Application jerseyApplication(Environment environment,
            ResourceLoader resourceLoader) &#123;
  
          ClassPathScanningCandidateComponentProvider provider = new ClassPathScanningCandidateComponentProvider(
                  false, environment);
  
          // Filter to include only classes that have a particular annotation.
          provider.addIncludeFilter(new AnnotationTypeFilter(Path.class));
          provider.addIncludeFilter(new AnnotationTypeFilter(Provider.class));
  
          // Find classes in Eureka packages (or subpackages)
          Set&lt;Class&lt;?&gt;&gt; classes = new HashSet&lt;&gt;();
          for (String basePackage : EUREKA_PACKAGES) &#123;
              Set&lt;BeanDefinition&gt; beans = provider.findCandidateComponents(basePackage);
              for (BeanDefinition bd : beans) &#123;
                  Class&lt;?&gt; cls = ClassUtils.resolveClassName(bd.getBeanClassName(),
                          resourceLoader.getClassLoader());
                  classes.add(cls);
              &#125;
          &#125;
  
          // Construct the Jersey ResourceConfig
          Map&lt;String, Object&gt; propsAndFeatures = new HashMap&lt;&gt;();
          propsAndFeatures.put(
                  // Skip static content used by the webapp
                  ServletContainer.PROPERTY_WEB_PAGE_CONTENT_REGEX,
                  EurekaConstants.DEFAULT_PREFIX + &quot;/(fonts|images|css|js)/.*&quot;);
  
          DefaultResourceConfig rc = new DefaultResourceConfig(classes);
          rc.setPropertiesAndFeatures(propsAndFeatures);
  
          return rc;
    &#125;

    @Bean
    @ConditionalOnBean(name = &quot;httpTraceFilter&quot;)
    public FilterRegistrationBean&lt;?&gt; traceFilterRegistration(
            @Qualifier(&quot;httpTraceFilter&quot;) Filter filter) &#123;
        FilterRegistrationBean&lt;Filter&gt; bean = new FilterRegistrationBean&lt;Filter&gt;();
        bean.setFilter(filter);
        bean.setOrder(Ordered.LOWEST_PRECEDENCE - 10);
        return bean;
    &#125;

    /** 配置 Eureka服务器配置Bean **/
    @Configuration(proxyBeanMethods = false)
    protected static class EurekaServerConfigBeanConfiguration &#123;

        @Bean
        @ConditionalOnMissingBean
        public EurekaServerConfig eurekaServerConfig(EurekaClientConfig clientConfig) &#123;
            EurekaServerConfigBean server = new EurekaServerConfigBean();
            if (clientConfig.shouldRegisterWithEureka()) &#123;
                //设置注册表同步重试次数
                server.setRegistrySyncRetries(5);
            &#125;
            return server;
        &#125;
    &#125;
&#125;
</code></pre>
<h2 id="4-EurekaServerInitializerConfiguration源码"><a href="#4-EurekaServerInitializerConfiguration源码" class="headerlink" title="4.EurekaServerInitializerConfiguration源码"></a>4.EurekaServerInitializerConfiguration源码</h2><blockquote>
<p>主要作用管理EurekaServer服务生命周期</p>
</blockquote>
<pre><code class="java">/** 
 * 实现了Lifecycle方法，对象初始化完成后开始执行start()、对象销毁时调用stop()
 * **/
@Configuration(proxyBeanMethods = false)
public class EurekaServerInitializerConfiguration
        implements ServletContextAware, SmartLifecycle, Ordered &#123;
    
    @Override
    public void start() &#123;
      new Thread(() -&gt; &#123;
        try &#123;
          /** TODO【重要】初始化环境变量、启动EurekaServer节点、同步注册表信息等 **/
          eurekaServerBootstrap.contextInitialized(
                  EurekaServerInitializerConfiguration.this.servletContext);
          log.info(&quot;Started Eureka Server&quot;);
  
          //发布注册表可用事件
          publish(new EurekaRegistryAvailableEvent(getEurekaServerConfig()));
        
          //设置EurekaServer服务状态为running
          EurekaServerInitializerConfiguration.this.running = true;
        
          //发布EurekaServer启动成功事件
          publish(new EurekaServerStartedEvent(getEurekaServerConfig()));
        &#125; catch (Exception ex) &#123;
          // Help!
          log.error(&quot;Could not initialize Eureka servlet context&quot;, ex);
        &#125;
      &#125;).start();
    &#125;
  
    /** bean销毁前运行 **/
    @Override
    public void stop() &#123;
        this.running = false;
        eurekaServerBootstrap.contextDestroyed(this.servletContext);
    &#125;
&#125;
</code></pre>
<h3 id="4-1-EurekaServerBootstrap源码解析"><a href="#4-1-EurekaServerBootstrap源码解析" class="headerlink" title="4.1.EurekaServerBootstrap源码解析"></a>4.1.EurekaServerBootstrap源码解析</h3><blockquote>
<p>启动引导, 提供初始化、销毁方法</p>
</blockquote>
<pre><code class="java">class EurekaServerBootstrap&#123;
    /** 初始化EurekaServerContext **/
    public void contextInitialized(ServletContext context) &#123;
        try &#123;
            //初始化环境变量
            initEurekaEnvironment();
            //TODO【重要】初始化Eureka节点列表、同步注册表信息等
            initEurekaServerContext();
          
            context.setAttribute(EurekaServerContext.class.getName(), this.serverContext);
        &#125; catch (Throwable e) &#123;
            log.error(&quot;Cannot bootstrap eureka server :&quot;, e);
            throw new RuntimeException(&quot;Cannot bootstrap eureka server :&quot;, e);
        &#125;
    &#125;

    /** 销毁EurekaServerContext **/
    public void contextDestroyed(ServletContext context) &#123;
      try &#123;
          log.info(&quot;Shutting down Eureka Server..&quot;);
          context.removeAttribute(EurekaServerContext.class.getName());
  
          //关闭Eureka监视器、关闭上下文等
          destroyEurekaServerContext();
        
          //用户可以重写次方法来清理环境变量
          destroyEurekaEnvironment();
      &#125; catch (Throwable e) &#123;
        log.error(&quot;Error shutting down eureka&quot;, e);
      &#125;
      log.info(&quot;Eureka Service is now shutdown...&quot;);
    &#125;


  protected void initEurekaServerContext() throws Exception &#123;
    // For backward compatibility
    JsonXStream.getInstance().registerConverter(new V1AwareInstanceInfoConverter(),
            XStream.PRIORITY_VERY_HIGH);
    XmlXStream.getInstance().registerConverter(new V1AwareInstanceInfoConverter(),
            XStream.PRIORITY_VERY_HIGH);

    if (isAws(this.applicationInfoManager.getInfo())) &#123;
      this.awsBinder = new AwsBinderDelegate(this.eurekaServerConfig,
              this.eurekaClientConfig, this.registry, this.applicationInfoManager);
      this.awsBinder.start();
    &#125;

    //初始化上下文holder
    EurekaServerContextHolder.initialize(this.serverContext);

    log.info(&quot;Initialized server context&quot;);

    //从相邻节点同步注册信息
    int registryCount = this.registry.syncUp();

    //启动各种异步任务、修改实例状态为UP、开启实例主动下线任务
    this.registry.openForTraffic(this.applicationInfoManager, registryCount);

    // 注册所有监控统计信息。
    EurekaMonitors.registerAllStats();
  &#125;
&#125;
</code></pre>
<h4 id="4-1-1-EurekaServerContext详解"><a href="#4-1-1-EurekaServerContext详解" class="headerlink" title="4.1.1.EurekaServerContext详解"></a>4.1.1.EurekaServerContext详解</h4><blockquote>
<p>实际是初始化了DefaultEurekaServerContext类,在EurekaServerAutoConfiguration中初始化</p>
</blockquote>
<pre><code class="java">@Singleton
public class DefaultEurekaServerContext implements EurekaServerContext &#123;
    private static final Logger logger = LoggerFactory.getLogger(DefaultEurekaServerContext.class);
  
    private final PeerAwareInstanceRegistry registry;
    private final PeerEurekaNodes peerEurekaNodes;

    @PostConstruct
    @Override
    public void initialize() &#123;
      logger.info(&quot;Initializing ...&quot;);
      /**
       * TODO【重要】
       * 1.创建单线程池作为异步任务线程
       * 2.更新eureka节点集合
       * 3.创建一个周期性异步任务
       *     10分钟更新一次eureka节点集合
       * **/
      peerEurekaNodes.start();
      try &#123;
          /** 
           * TODO【重要】
           * 1.60s更新一次最近最小复制次数
           * 2.初始化响应缓存、开启定时更新client端缓存任务,30s更新一次
           * 3.开启定时更新&lt;更新阈值&gt;任务。更新阈值将用于确定是否由于网络分区而导致更新数量急剧下降，并保护一次过期的实例过多。
           * 4.初始化注册中心
           * **/
        registry.init(peerEurekaNodes);
      &#125; catch (Exception e) &#123;
        throw new RuntimeException(e);
      &#125;
      logger.info(&quot;Initialized&quot;);
    &#125;
  
    /** 关闭各种容器、监视器等 **/
    @PreDestroy
    @Override
    public void shutdown() &#123;
      logger.info(&quot;Shutting down ...&quot;);
      registry.shutdown();
      peerEurekaNodes.shutdown();
      ServoControl.shutdown();
      EurekaMonitors.shutdown();
      logger.info(&quot;Shut down&quot;);
    &#125;
    //。。。
&#125;
</code></pre>
<h3 id="4-2-peerEurekaNodes-start-分析"><a href="#4-2-peerEurekaNodes-start-分析" class="headerlink" title="4.2.peerEurekaNodes.start()分析"></a>4.2.peerEurekaNodes.start()分析</h3><blockquote>
<p>更新节点集合，并定义定时更新节点集合任务</p>
</blockquote>
<pre><code class="java">@Singleton
public class PeerEurekaNodes &#123;
    public void start() &#123;
        //单线程线程池
        taskExecutor = Executors.newSingleThreadScheduledExecutor(
                new ThreadFactory() &#123;
                  @Override
                  public Thread newThread(Runnable r) &#123;
                    Thread thread = new Thread(r, &quot;Eureka-PeerNodesUpdater&quot;);
                    thread.setDaemon(true);
                    return thread;
                  &#125;
                &#125;
        );
        try &#123;
          
            //更新eureka节点集合
            updatePeerEurekaNodes(resolvePeerUrls());
          
            //定义异步任务
            Runnable peersUpdateTask = new Runnable() &#123;
              @Override
              public void run() &#123;
                try &#123;
                  updatePeerEurekaNodes(resolvePeerUrls());
                &#125; catch (Throwable e) &#123;
                  logger.error(&quot;Cannot update the replica Nodes&quot;, e);
                &#125;
              &#125;
            &#125;;

            //10分钟执行一次更新eureka节点任务
            taskExecutor.scheduleWithFixedDelay(
                    peersUpdateTask,
                    serverConfig.getPeerEurekaNodesUpdateIntervalMs(),
                    serverConfig.getPeerEurekaNodesUpdateIntervalMs(),
                    TimeUnit.MILLISECONDS
            );
        &#125; catch (Exception e) &#123;
          throw new IllegalStateException(e);
        &#125;
        for (PeerEurekaNode node : peerEurekaNodes) &#123;
          logger.info(&quot;Replica node URL:  &#123;&#125;&quot;, node.getServiceUrl());
        &#125;
    &#125;
  
    //解析eureka节点url
    protected List&lt;String&gt; resolvePeerUrls() &#123;
        InstanceInfo myInfo = applicationInfoManager.getInfo();
        String zone = InstanceInfo.getZone(clientConfig.getAvailabilityZones(clientConfig.getRegion()), myInfo);
        List&lt;String&gt; replicaUrls = EndpointUtils
                .getDiscoveryServiceUrls(clientConfig, zone, new EndpointUtils.InstanceInfoBasedUrlRandomizer(myInfo));
      
        int idx = 0;
        while (idx &lt; replicaUrls.size()) &#123;
          if (isThisMyUrl(replicaUrls.get(idx))) &#123;
            replicaUrls.remove(idx);
          &#125; else &#123;
            idx++;
          &#125;
        &#125;
        return replicaUrls;
    &#125;
  
    //更新Eureka节点信息集合
    protected void updatePeerEurekaNodes(List&lt;String&gt; newPeerUrls) &#123;
      if (newPeerUrls.isEmpty()) &#123;
        logger.warn(&quot;The replica size seems to be empty. Check the route 53 DNS Registry&quot;);
        return;
      &#125;
  
      Set&lt;String&gt; toShutdown = new HashSet&lt;&gt;(peerEurekaNodeUrls);
      toShutdown.removeAll(newPeerUrls);
      Set&lt;String&gt; toAdd = new HashSet&lt;&gt;(newPeerUrls);
      toAdd.removeAll(peerEurekaNodeUrls);
  
      if (toShutdown.isEmpty() &amp;&amp; toAdd.isEmpty()) &#123; // No change
        return;
      &#125;
  
      // Remove peers no long available
      List&lt;PeerEurekaNode&gt; newNodeList = new ArrayList&lt;&gt;(peerEurekaNodes);
  
      if (!toShutdown.isEmpty()) &#123;
        logger.info(&quot;Removing no longer available peer nodes &#123;&#125;&quot;, toShutdown);
        int i = 0;
        while (i &lt; newNodeList.size()) &#123;
          PeerEurekaNode eurekaNode = newNodeList.get(i);
          if (toShutdown.contains(eurekaNode.getServiceUrl())) &#123;
              newNodeList.remove(i);
              eurekaNode.shutDown();
          &#125; else &#123;
              i++;
          &#125;
        &#125;
      &#125;
  
      // Add new peers
      if (!toAdd.isEmpty()) &#123;
        logger.info(&quot;Adding new peer nodes &#123;&#125;&quot;, toAdd);
        for (String peerUrl : toAdd) &#123;
            newNodeList.add(createPeerEurekaNode(peerUrl));
        &#125;
      &#125;
  
      this.peerEurekaNodes = newNodeList;
      this.peerEurekaNodeUrls = new HashSet&lt;&gt;(newPeerUrls);
    &#125;
&#125;
</code></pre>
<h3 id="4-3-registry-init-分析"><a href="#4-3-registry-init-分析" class="headerlink" title="4.3.registry.init()分析"></a>4.3.registry.init()分析</h3><blockquote>
<p>初始化响应缓存、处理二级缓存相关业务逻辑</p>
</blockquote>
<pre><code class="java">@Singleton
public class PeerAwareInstanceRegistryImpl extends AbstractInstanceRegistry implements PeerAwareInstanceRegistry &#123;
    @Override
    public void init(PeerEurekaNodes peerEurekaNodes) throws Exception &#123;
        //1分钟更新一次最后最小复制数
        this.numberOfReplicationsLastMin.start();
        this.peerEurekaNodes = peerEurekaNodes;
      
        /** 
         * 初始化响应缓存，过期时间
         * 此处做了两级缓存，根据shouldUseReadOnlyResponseCache=true判断，默认true
         *     ps:通过eureka.shouldUseReadOnlyResponseCache配置
         *  
         *  readWriteCacheMap(二级缓存,缓存180s)、readOnlyCacheMap(三级缓存,30s刷新一次)
         *      readOnlyCacheMap 定时从 readWriteCacheMap 中更新缓存
         * **/
        initializedResponseCache();
        scheduleRenewalThresholdUpdateTask();
        initRemoteRegionRegistry();
  
        try &#123;
          Monitors.registerObject(this);
        &#125; catch (Throwable e) &#123;
          logger.warn(&quot;Cannot register the JMX monitor for the InstanceRegistry :&quot;, e);
        &#125;
    &#125;
&#125;
</code></pre>
<ul>
<li>Eureka中的三级缓存</li>
</ul>
<table>
<thead>
<tr>
<th>缓存</th>
<th>数据类型</th>
<th>源码中位置</th>
<th>描述</th>
</tr>
</thead>
<tbody><tr>
<td>registry(一级)</td>
<td>ConcurrentHashMap&lt;String, Map&lt;String, Lease<InstanceInfo>&gt;&gt;</td>
<td>AbstractInstanceRegistry.registry</td>
<td>实时更新，又称<strong>注册表</strong>，UI界面从这里获取服务注册信息</td>
</tr>
<tr>
<td>readWriteCacheMap(二级)</td>
<td>com.google.common.cache.LoadingCache</td>
<td>ResponseCacheImpl</td>
<td>缓存时间默认180秒(eureka.responseCacheAutoExpirationInSeconds配置)</td>
</tr>
<tr>
<td>readOnlyCacheMap(三级)</td>
<td>ConcurrentHashMap</td>
<td>ResponseCacheImpl</td>
<td>每30s同步readWriteCacheMap数据，EurekaClient默认从这里获取服务注册信息(可配置)</td>
</tr>
</tbody></table>
<ul>
<li>init中计算任务开始时间代码示例</li>
</ul>
<pre><code class="java">class Test &#123;
  /** registry.init()中计算任务开始时间 **/
  public static void main(String[] args) throws InterruptedException &#123;
    int responseCacheUpdateIntervalMs = 30 * 1000;
    for(int i=0; i&lt;3; i++)&#123;
      Thread.sleep(1000);
      Date dt = new Date(
              ( (System.currentTimeMillis() / responseCacheUpdateIntervalMs) * responseCacheUpdateIntervalMs)
                      + responseCacheUpdateIntervalMs);
      System.out.println(DateUtils.formatDateYMDHMS(dt));
    &#125;
  &#125;

  /**
   * 结果: 
   * 2022-11-23 14:45:30
   * 2022-11-23 14:45:30
   * 2022-11-23 14:45:30
   * **/
&#125;
</code></pre>
<h2 id="5-同步集群节点注册表-PeerAwareInstanceRegistry-syncUp"><a href="#5-同步集群节点注册表-PeerAwareInstanceRegistry-syncUp" class="headerlink" title="5.同步集群节点注册表 PeerAwareInstanceRegistry.syncUp()"></a>5.同步集群节点注册表 PeerAwareInstanceRegistry.syncUp()</h2><pre><code class="java">class PeerAwareInstanceRegistry &#123;
    @Override
    public int syncUp() &#123;
      // 统计同步到本地注册表的实例数
      int count = 0;
    
      // 默认重试5次，每次间隔30秒, 成功一次则不再重试
      for (int i = 0; ((i &lt; serverConfig.getRegistrySyncRetries()) &amp;&amp; (count == 0)); i++) &#123;
        if (i &gt; 0) &#123;
          try &#123;
            Thread.sleep(serverConfig.getRegistrySyncRetryWaitMs());
          &#125; catch (InterruptedException e) &#123;
            logger.warn(&quot;Interrupted during registry transfer..&quot;);
            break;
          &#125;
        &#125;
        // 拉取集群节点注册表中的服务实例信息
        Applications apps = eurekaClient.getApplications();
        for (Application app : apps.getRegisteredApplications()) &#123;
          for (InstanceInfo instance : app.getInstances()) &#123;
            try &#123;
              if (isRegisterable(instance)) &#123;
                  //TODO【重要】注册实例到本地注册表
                  register(instance, instance.getLeaseInfo().getDurationInSecs(), true);
                  count++;
              &#125;
            &#125; catch (Throwable t) &#123;
              logger.error(&quot;During DS init copy&quot;, t);
            &#125;
          &#125;
        &#125;
      &#125;
      return count;
    &#125;
&#125;
</code></pre>
<h2 id="6-PeerAwareInstanceRegistry-openForTraffic"><a href="#6-PeerAwareInstanceRegistry-openForTraffic" class="headerlink" title="6.PeerAwareInstanceRegistry.openForTraffic()"></a>6.PeerAwareInstanceRegistry.openForTraffic()</h2><pre><code class="java">@Singleton
public class PeerAwareInstanceRegistryImpl extends AbstractInstanceRegistry implements PeerAwareInstanceRegistry &#123;
    @Override
    public void openForTraffic(ApplicationInfoManager applicationInfoManager, int count) &#123;
        //...省略
        logger.info(&quot;Changing status to UP&quot;);
        //设置状态
        applicationInfoManager.setInstanceStatus(InstanceStatus.UP);
        //执行初始化后,后续任务
        super.postInit();
    &#125;
&#125;

public abstract class AbstractInstanceRegistry implements InstanceRegistry &#123;
    private final AtomicReference&lt;EvictionTask&gt; evictionTaskRef = new AtomicReference&lt;EvictionTask&gt;();
    protected void postInit() &#123;
      renewsLastMin.start();
      //驱逐任务
      if (evictionTaskRef.get() != null) &#123;
            evictionTaskRef.get().cancel();
      &#125;
      evictionTaskRef.set(new EvictionTask());
      //启动定时驱逐任务
      evictionTimer.schedule(evictionTaskRef.get(),
              serverConfig.getEvictionIntervalTimerInMs(),
              serverConfig.getEvictionIntervalTimerInMs());
    &#125;
&#125;
</code></pre>
<h2 id="7-启动过程总结"><a href="#7-启动过程总结" class="headerlink" title="7.启动过程总结"></a>7.启动过程总结</h2><pre><code class="textmate">1.加载配置
    eureka.server
    eureka.dashboard
    eureka.instance.registry
    /eureka/server.properties

2.初始化相关类
    初始化PeerEurekaNodes(EurekaServer节点类)
    初始化EurekaServerBootstrap、
    初始化上下文及其他相关类

3.初始化EurekaServer
    初始化环境变量
    初始化EurekaServer上下文、同步节点信息、启动异步任务、修改实例状态
    发布相关事件(注册表可用事件、EurekaServer启动事件)
</code></pre>

      
    </div>
</article>


<p>
    <a  class="dashang" onclick="dashangToggle()">赏</a>
</p>


<div class="article_copyright">
    <p><span class="copy-title">文章标题:</span>Eureka源码学习笔记(一)</p>
    <p><span class="copy-title">字数:</span><span class="post-count">3.9k</span></p>
    <p><span class="copy-title">本文作者:</span><a  title="imfan">imfan</a></p>
    <p><span class="copy-title">发布时间:</span>2022-09-28, 16:50:00</p>
    <p><span class="copy-title">最后更新:</span>2023-03-16, 17:14:16</p>
    <span class="copy-title">原始链接:</span><a class="post-url" href="/2022/09/28/backend/service/eureka/eureka-1/" title="Eureka源码学习笔记(一)">https://wiki.aistart.cc/2022/09/28/backend/service/eureka/eureka-1/</a>
    <p>
        <span class="copy-title">版权声明:</span><i class="fa fa-creative-commons"></i> <a rel="license noopener" target="_blank" href="http://creativecommons.org/licenses/by-nc-sa/4.0/" title="CC BY-NC-SA 4.0 International" target = "_blank">&#34;署名-非商用-相同方式共享 4.0&#34;</a> 转载请保留原文链接及作者。
    </p>
</div>






    




    </div>
    <div class="copyright">
        <!--
<p class="footer-entry">
    ©2015-2022 Imfan
</p>
<p class="footer-entry">Built with <a href="https://hexo.io/" target="_blank">Hexo</a> and <a href="https://github.com/yelog/hexo-theme-3-hexo" target="_blank">3-hexo</a> theme</p>
 -->

    </div>
    <div class="full-toc">
        <button class="full" data-title="切换全屏 快捷键 s"><span class="min "></span></button>
<a class="" id="rocket" ></a>

    </div>
</div>

<div class="hide_box" onclick="dashangToggle()"></div>
<div class="shang_box">
    <a class="shang_close"  onclick="dashangToggle()">×</a>
    <div class="shang_tit">
        <p>喜欢就点赞,疼爱就打赏</p>
    </div>
    <div class="shang_payimg">
        <div class="pay_img">
            <img src="/img/alipay.jpg" class="alipay" title="扫码支持">
            <img src="/img/weixin.jpg" class="weixin" title="扫码支持">
        </div>
    </div>
    <div class="shang_payselect">
        <span><label><input type="radio" name="pay" checked value="alipay">支付宝</label></span><span><label><input type="radio" name="pay" value="weixin">微信</label></span>
    </div>
</div>


</body>
<script src="/js/jquery.pjax.js?v=1.1.0" ></script>

<script src="https://cdn.bootcdn.net/ajax/libs/photoswipe/4.1.3/photoswipe.min.js"></script>
<script src="https://cdn.bootcdn.net/ajax/libs/photoswipe/4.1.3/photoswipe-ui-default.min.js"></script>

<script src="/js/script.js?v=1.1.0" ></script>
<script>
    var img_resize = 'photoSwipe';
    function initArticle() {
        /*渲染对应的表格样式*/
        
            $("#post .pjax table").addClass("green_title");
        

        /*渲染打赏样式*/
        
        $("input[name=pay]").on("click", function () {
            if($("input[name=pay]:checked").val()=="weixin"){
                $(".shang_box .shang_payimg .pay_img").addClass("weixin_img");
            } else {
                $(".shang_box .shang_payimg .pay_img").removeClass("weixin_img");
            }
        })
        

        /*高亮代码块行号*/
        
        $('pre code').each(function(){
            var lines = $(this).text().trim().split('\n').length, widther='';
            if (lines>99) {
                widther = 'widther'
            }
            var $numbering = $('<ul/>').addClass('pre-numbering ' + widther).attr("unselectable","on");
            $(this).addClass('has-numbering ' + widther)
                    .parent()
                    .append($numbering);
            for(var i=1;i<=lines;i++){
                $numbering.append($('<li/>').text(i));
            }
        });
        

        /*访问数量*/
        
        $.getScript("//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js");
        

        /*代码高亮，行号对齐*/
        $('.pre-numbering').css('line-height',$('.has-numbering').css('line-height'));

        

        // PhotoSwipe
        $('article').each(function(i){
            $(this).find('img').each(function(){
                if ($(this).closest('figure').hasClass('article-gallery-img')) {
                    return;
                }
                var alt = this.alt;
                $(this)
                    .wrap('<figure class="article-gallery-img" itemprop="associatedMedia" itemscope itemtype="http://schema.org/ImageObject"></figure>')
                    .wrap('<a href="' + this.src + '" title="' + alt + '"></a>');
                $(this).after('<div class="img_alt"><span>' + (alt || '') + '</span></div>');
            });
        });

        var pswpElement = document.querySelectorAll('.pswp')[0];
        if (pswpElement) {
            var gallerySelector = '.article-gallery, article';

            var initPhotoSwipeFromDOM = function(gallerySelector) {

                // parse slide data (url, title, size ...) from DOM elements
                // (children of gallerySelector)
                var parseThumbnailElements = function(el) {
                    var thumbElements = $(el).find('figure.article-gallery-img').toArray(),
                        numNodes = thumbElements.length,
                        items = [],
                        figureEl,
                        linkEl,
                        size,
                        imgEl,
                        item;

                    for (var i = 0; i < numNodes; i++) {

                        figureEl = thumbElements[i]; // <figure> element

                        // include only element nodes
                        if (figureEl.nodeType !== 1) {
                            continue;
                        }

                        linkEl = figureEl.children[0]; // <a> element
                        imgEl = linkEl.children[0]; // <img>

                        size = linkEl.getAttribute('data-size');
                        size = size && size.split('x');

                        // create slide object
                        item = {
                            src: linkEl.getAttribute('href'),
                            w: size && parseInt(size[0], 10) || imgEl.width,
                            h: size && parseInt(size[1], 10) || imgEl.height
                        };

                        if (figureEl.children.length > 1) {
                            // <figcaption> content
                            item.title = figureEl.children[1].innerHTML;
                        }

                        if (linkEl.children.length > 0) {
                            // <img> thumbnail element, retrieving thumbnail url
                            item.msrc = linkEl.children[0].getAttribute('src');
                        }

                        item.el = figureEl; // save link to element for getThumbBoundsFn
                        items.push(item);
                    }

                    return items;
                };

                // find nearest parent element
                var closest = function closest(el, fn) {
                    return el && (fn(el) ? el : closest(el.parentNode, fn));
                };

                // triggers when user clicks on thumbnail
                var onThumbnailsClick = function(e) {
                    e = e || window.event;

                    var eTarget = e.target || e.srcElement;

                    // find root element of slide
                    var clickedListItem = closest(eTarget, function(el) {
                        return (el.tagName && el.tagName.toUpperCase() === 'FIGURE');
                    });

                    if (!clickedListItem) {
                        return;
                    }

                    if (e.preventDefault) {
                        e.preventDefault();
                    } else {
                        e.returnValue = false;
                    }

                    // find index of clicked item by looping through all child nodes
                    // alternatively, you may define index via data- attribute
                    var clickedGallery = $(clickedListItem).closest(gallerySelector)[0],
                        childNodes = $(clickedGallery).find('figure.article-gallery-img').toArray(),
                        numChildNodes = childNodes.length,
                        nodeIndex = 0,
                        index;

                    for (var i = 0; i < numChildNodes; i++) {
                        if (childNodes[i].nodeType !== 1) {
                            continue;
                        }

                        if (childNodes[i] === clickedListItem) {
                            index = nodeIndex;
                            break;
                        }
                        nodeIndex++;
                    }



                    if (index >= 0) {
                        // open PhotoSwipe if valid index found
                        openPhotoSwipe(index, clickedGallery);
                    }
                    return false;
                };

                // parse picture index and gallery index from URL (#&pid=1&gid=2)
                var photoswipeParseHash = function() {
                    var hash = window.location.hash.substring(1),
                        params = {};

                    if (hash.length < 5) {
                        return params;
                    }

                    var vars = hash.split('&');
                    for (var i = 0; i < vars.length; i++) {
                        if (!vars[i]) {
                            continue;
                        }
                        var pair = vars[i].split('=');
                        if (pair.length < 2) {
                            continue;
                        }
                        params[pair[0]] = pair[1];
                    }

                    if (params.gid) {
                        params.gid = parseInt(params.gid, 10);
                    }

                    return params;
                };

                var openPhotoSwipe = function(index, galleryElement, disableAnimation, fromURL) {
                    var pswpElement = document.querySelectorAll('.pswp')[0],
                        gallery,
                        options,
                        items;

                    items = parseThumbnailElements(galleryElement);

                    // define options (if needed)
                    options = {

                        // define gallery index (for URL)
                        galleryUID: galleryElement.getAttribute('data-pswp-uid'),

                        getThumbBoundsFn: function(index) {
                            // See Options -> getThumbBoundsFn section of documentation for more info
                            var thumbnail = items[index].el.getElementsByTagName('img')[0], // find thumbnail
                                pageYScroll = window.pageYOffset || document.documentElement.scrollTop,
                                rect = thumbnail.getBoundingClientRect();

                            return {
                                x: rect.left,
                                y: rect.top + pageYScroll,
                                w: rect.width
                            };
                        }
                    };

                    // PhotoSwipe opened from URL
                    if (fromURL) {
                        if (options.galleryPIDs) {
                            // parse real index when custom PIDs are used
                            // http://photoswipe.com/documentation/faq.html#custom-pid-in-url
                            for (var j = 0; j < items.length; j++) {
                                if (items[j].pid == index) {
                                    options.index = j;
                                    break;
                                }
                            }
                        } else {
                            // in URL indexes start from 1
                            options.index = parseInt(index, 10) - 1;
                        }
                    } else {
                        options.index = parseInt(index, 10);
                    }

                    // exit if index not found
                    if (isNaN(options.index)) {
                        return;
                    }

                    if (disableAnimation) {
                        options.showAnimationDuration = 0;
                    }

                    // Pass data to PhotoSwipe and initialize it
                    gallery = new PhotoSwipe(pswpElement, PhotoSwipeUI_Default, items, options);

                    gallery.listen('imageLoadComplete', function(index, item) {
                        var linkEl = item.el.children[0];
                        var img = item.container.children[0];
                        if (!linkEl.getAttribute('data-size')) {
                            linkEl.setAttribute('data-size', img.naturalWidth + 'x' + img.naturalHeight);
                            item.w = img.naturalWidth;
                            item.h = img.naturalHeight;
                            gallery.invalidateCurrItems();
                            gallery.updateSize(true);
                        }
                    });

                    gallery.init();
                };

                // loop through all gallery elements and bind events
                var galleryElements = document.querySelectorAll(gallerySelector);

                for (var i = 0, l = galleryElements.length; i < l; i++) {
                    galleryElements[i].setAttribute('data-pswp-uid', i + 1);
                    galleryElements[i].onclick = onThumbnailsClick;
                }

                // Parse URL and open gallery if it contains #&pid=3&gid=1
                var hashData = photoswipeParseHash();
                if (hashData.pid && hashData.gid) {
                    openPhotoSwipe(hashData.pid, galleryElements[hashData.gid - 1], true, true);
                }
            };

            // execute above function
            initPhotoSwipeFromDOM(gallerySelector);
        }
        
        
        /* 渲染*/
        function HTMLDecode(text) {
            var temp = document.createElement("div");
            temp.innerHTML = text;
            var output = temp.innerText || temp.textContent;
            temp = null;
            return output;
        }
        if (window.mermaid){
            window.mermaid = null
        }
        $.getScript("https://cdn.bootcdn.net/ajax/libs/mermaid/8.4.2/mermaid.min.js", function () {
            var mermaidOptions = JSON.parse(HTMLDecode("{&#34;theme&#34;:&#34;default&#34;,&#34;startOnLoad&#34;:true,&#34;flowchart&#34;:{&#34;useMaxWidth&#34;:false,&#34;htmlLabels&#34;:true}}"))
            if (window.mermaid) {
                mermaid.initialize(mermaidOptions)
                mermaid.contentLoaded()
            }
        })
        
    }

    /*打赏页面隐藏与展示*/
    
    function dashangToggle() {
        $(".shang_box").fadeToggle();
        $(".hide_box").fadeToggle();
    }
    

</script>

<!--加入行号的高亮代码块样式-->

<style>
    pre{
        position: relative;
        margin-bottom: 24px;
        border-radius: 10px;
        border: 1px solid #e2dede;
        background: #FFF;
        overflow: hidden;
    }
    code.has-numbering{
        margin-left: 30px;
    }
    code.has-numbering.widther{
        margin-left: 35px;
    }
    .pre-numbering{
        margin: 0;
        position: absolute;
        top: 0;
        left: 0;
        width: 20px;
        padding: 0.5em 3px 0.7em 5px;
        border-right: 1px solid #C3CCD0;
        text-align: right;
        color: #AAA;
        background-color: ;
    }
    .pre-numbering.widther {
        width: 35px;
    }
</style>

<!--自定义样式设置-->
<style>
    
    
    .nav {
        width: 542px;
    }
    .nav.fullscreen {
        margin-left: -542px;
    }
    .nav-left {
        width: 120px;
    }
    
    
    @media screen and (max-width: 1468px) {
        .nav {
            width: 492px;
        }
        .nav.fullscreen {
            margin-left: -492px;
        }
        .nav-left {
            width: 100px;
        }
    }
    
    
    @media screen and (max-width: 1024px) {
        .nav {
            width: 492px;
            margin-left: -492px
        }
        .nav.fullscreen {
            margin-left: 0;
        }
    }
    
    @media screen and (max-width: 426px) {
        .nav {
            width: 100%;
        }
        .nav-left {
            width: 100%;
        }
    }
    
    
    .nav-right .title-list nav a .post-title, .nav-right .title-list #local-search-result a .post-title {
        color: #c0bfbf;
    }
    
    
    .nav-right .title-list nav a .post-date, .nav-right .title-list #local-search-result a .post-date {
        color: #2b2929;
    }
    
    
    .nav-right nav a.hover, #local-search-result a.hover{
        background-color: #e2e0e0;
    }
    
    

    /*列表样式*/
    

    /* 背景图样式 */
    
    #post {
        background: url(/img/background/index-1920x1200.jpg);
    }
    
    


    /*引用块样式*/
    

    /*文章列表背景图*/
    
    .nav-right:before {
        content: ' ';
        display: block;
        position: absolute;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        opacity: 0.5;
        background: url("/img/moon.jpg");
        background-repeat: no-repeat;
        background-position: 50% 0;
        -ms-background-size: cover;
        -o-background-size: cover;
        -moz-background-size: cover;
        -webkit-background-size: cover;
        background-size: cover;
    }
    

    
    #post .pjax article :not(pre) > code {
        color: #24292e;
        font-family: SFMono-Regular,Consolas,Liberation Mono,Menlo,Courier,monospace;
        background-color: rgba(27,31,35,.05);
        border-radius: 3px;
        font-size: 85%;
        margin: 0;
        padding: .2em .4em;
    }
    
</style>


<!-- Root element of PhotoSwipe. Must have class pswp. -->
<div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">

    <!-- Background of PhotoSwipe.
         It's a separate element, as animating opacity is faster than rgba(). -->
    <div class="pswp__bg"></div>

    <!-- Slides wrapper with overflow:hidden. -->
    <div class="pswp__scroll-wrap">

        <!-- Container that holds slides. PhotoSwipe keeps only 3 slides in DOM to save memory. -->
        <!-- don't modify these 3 pswp__item elements, data is added later on. -->
        <div class="pswp__container">
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
        </div>

        <!-- Default (PhotoSwipeUI_Default) interface on top of sliding area. Can be changed. -->
        <div class="pswp__ui pswp__ui--hidden">

            <div class="pswp__top-bar">

                <!--  Controls are self-explanatory. Order can be changed. -->

                <div class="pswp__counter"></div>

                <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>

                <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>

                <!-- Preloader demo https://codepen.io/dimsemenov/pen/yyBWoR -->
                <!-- element will get class pswp__preloader--active when preloader is running -->
                <div class="pswp__preloader">
                    <div class="pswp__preloader__icn">
                        <div class="pswp__preloader__cut">
                            <div class="pswp__preloader__donut"></div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
                <div class="pswp__share-tooltip"></div>
            </div>

            <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
            </button>

            <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
            </button>

            <div class="pswp__caption">
                <div class="pswp__caption__center"></div>
            </div>

        </div>

    </div>

</div>






</html>
